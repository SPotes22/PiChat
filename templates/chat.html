<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sala de Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #2f3136; color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h3 { margin-top: 0; }
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; background: #36393f; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; color: #dcddde; }
        .message { margin-bottom: 15px; }
        .message .user { font-weight: bold; color: #fff; }
        .message .text { margin-left: 10px; }
        .server-msg { font-style: italic; color: #8e9297; text-align: center; }
        #chat-form { display: flex; padding: 20px; background: #40444b; }
        #message_input { flex-grow: 1; padding: 10px; border: none; border-radius: 5px; background: #484c52; color: white; }
        #send_button { padding: 10px 15px; margin-left: 10px; border: none; background: #7289da; color: white; border-radius: 5px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border-radius: 3px; border: 1px solid #202225; background: #484c52; color: white;}
        .form-group button { width: 100%; padding: 10px; background: #7289da; color: white; border: none; border-radius: 5px; }
        .notice { font-size: 0.8em; color: #b9bbbe; padding: 10px; background: #202225; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Salas de Chat</h3>
        <div id="room-selection">
            <div class="form-group">
                <label for="room_code">C칩digo de Sala:</label>
                <input type="text" id="room_code" placeholder="C칩digo HEX de 8 chars">
            </div>
            <div class="form-group">
                <label for="password">Contrase침a:</label>
                <input type="password" id="password" placeholder="Contrase침a del chat">
            </div>
            <div class="form-group">
                 <input type="checkbox" id="is_group_chat">
                 <label for="is_group_chat">Chat Grupal (sin historial)</label>
            </div>
            <div class="form-group">
                <button onclick="joinChat()">Unirse / Crear Sala</button>
            </div>
             <div class="notice" id="private-chat-notice" style="display: none;">
                丘멆잺 "Always remember your password. You have to create another chat if you forget it."
            </div>
            <div class="notice" id="group-chat-notice" style="display: none;">
                游댎 "Messages will not be stored due to privacy."
            </div>
        </div>
        <a href="{{ url_for('inicio') }}" style="color: #b9bbbe; text-decoration: none; margin-top: auto;">Volver al Inicio</a>
    </div>

    <div class="chat-container">
        <div id="messages"></div>
        <form id="chat-form" style="display:none;">
	    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <input type="text" id="message_input" placeholder="Escribe un mensaje..." autocomplete="off">
            <button id="send_button" type="submit">Enviar</button>
        </form>
    </div>

    <script>
        const socket = io();
        let currentRoom = null;
        let isGroup = false;

        function joinChat() {
            const roomCode = document.getElementById('room_code').value.trim();
            const password = document.getElementById('password').value.trim();
            isGroup = document.getElementById('is_group_chat').checked;
            
            if (!roomCode || !password) {
                alert("El c칩digo de sala y la contrase침a son obligatorios.");
                return;
            }

            if (currentRoom) {
                socket.emit('leave', { 'room': currentRoom, 'is_group': isGroup });
            }
            
            currentRoom = roomCode;
            document.getElementById('messages').innerHTML = ''; // Limpiar chat
            socket.emit('join', { 'room': currentRoom, 'password': password, 'is_group': isGroup });

            document.getElementById('chat-form').style.display = 'flex';
            
            // Mostrar el aviso correspondiente
            document.getElementById('private-chat-notice').style.display = isGroup ? 'none' : 'block';
            document.getElementById('group-chat-notice').style.display = isGroup ? 'block' : 'none';
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const msg_input = document.getElementById('message_input');
            const msg = msg_input.value.trim();

            if (msg) {
                socket.emit('message', { 'room': currentRoom, 'msg': msg, 'is_group': isGroup });
                msg_input.value = '';
            }
        });

        socket.on('message', function(data) {
            const messages = document.getElementById('messages');
            const item = document.createElement('div');
            item.classList.add('message');
            
            if (data.user === 'Servidor') {
                item.classList.add('server-msg');
                item.textContent = data.msg;
            } else if (data.type === 'error') {
                 item.classList.add('server-msg');
                 item.style.color = 'red';
                 item.textContent = data.msg;
            } else {
                item.innerHTML = `<span class="user">${data.user}:</span><span class="text">${data.msg}</span>`;
            }
            
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; // Auto-scroll
        });
    </script>
</body>
</html>
